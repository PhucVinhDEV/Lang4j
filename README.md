# Chat Bot Lang4J

<div align="center">

**Intelligent E-commerce Chatbot with Function Calling & Intent Classification**

[![Java](https://img.shields.io/badge/Java-17-ED8B00?style=flat-square&logo=openjdk&logoColor=white)](https://openjdk.org/projects/jdk/17/)
[![Spring Boot](https://img.shields.io/badge/Spring%20Boot-3.4.5-6DB33F?style=flat-square&logo=spring-boot)](https://spring.io/projects/spring-boot)
[![LangChain4j](https://img.shields.io/badge/LangChain4j-1.0.0-FF6B35?style=flat-square&logo=chainlink&logoColor=white)](https://github.com/langchain4j/langchain4j)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-13+-316192?style=flat-square&logo=postgresql&logoColor=white)](https://www.postgresql.org/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg?style=flat-square)](https://opensource.org/licenses/MIT)

</div>

---

## üéØ Gi·ªõi thi·ªáu

H·ªá th·ªëng chatbot th√¥ng minh cho e-commerce ƒë∆∞·ª£c x√¢y d·ª±ng v·ªõi **Spring Boot** v√† **LangChain4j**. Chatbot c√≥ kh·∫£ nƒÉng:

- **ü§ñ Function Calling**: Truy v·∫•n database PostgreSQL th√¥ng qua c√°c function tools
- **üß† Intent Classification**: Ph√¢n lo·∫°i √Ω ƒë·ªãnh ng∆∞·ªùi d√πng v·ªõi semantic embedding
- **üîç Multi-mode Interaction**: 4 ch·∫ø ƒë·ªô chat kh√°c nhau cho c√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng kh√°c nhau
- **üìä Database Integration**: Qu·∫£n l√Ω s·∫£n ph·∫©m v√† danh m·ª•c ho√†n ch·ªânh

---

## üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

```mermaid
graph TB
    A[User Query] --> B[Intent Classification]
    B --> C{Semantic Intent Analysis}

    C -->|DATABASE_QUERY<br/>Structured Data| D[Function Calling Mode]
    C -->|VECTOR_SEARCH<br/>Advisory Queries| E[Vector RAG Mode]
    C -->|HYBRID<br/>General Chat| F[Direct LLM Mode]

    D --> G[Database Tools]
    G --> H[PostgreSQL]
    H --> I[Structured Results]

    E --> J[ChromaDB Vector Search]
    J --> K[Relevant Documents]

    F --> L[Direct Gemini Chat]

    I --> M[Gemini Response Generator]
    K --> M
    L --> M

    M --> N[Natural Language Response]

    subgraph "üîß Database Tools"
        G1[findProductById]
        G2[searchProductsByName]
        G3[findProductsByPriceRange]
        G4[getAllCategories]
        G5[getDatabaseStatistics]
    end

    G --> G1
    G --> G2
    G --> G3
    G --> G4
    G --> G5

    style A fill:#e1f5fe
    style N fill:#e8f5e8
    style C fill:#fff3e0
    style D fill:#fce4ec
    style E fill:#f3e5f5
    style F fill:#e0f2f1
```

---

## üß† Intent Classification System

H·ªá th·ªëng s·ª≠ d·ª•ng **Semantic Intent Classification** v·ªõi embedding model ƒë·ªÉ ph√¢n lo·∫°i √Ω ƒë·ªãnh ng∆∞·ªùi d√πng:

### 3 Lo·∫°i Intent Ch√≠nh

| Intent                | M√¥ t·∫£                        | V√≠ d·ª• c√¢u h·ªèi                                        | X·ª≠ l√Ω                         |
| --------------------- | ---------------------------- | ---------------------------------------------------- | ----------------------------- |
| **üóÑÔ∏è DATABASE_QUERY** | Truy v·∫•n d·ªØ li·ªáu c√≥ c·∫•u tr√∫c | "Gi√° iPhone l√† bao nhi√™u?", "T·ªìn kho s·∫£n ph·∫©m ID 5"  | Function Calling ‚Üí PostgreSQL |
| **üîç VECTOR_SEARCH**  | T√¨m ki·∫øm ng·ªØ nghƒ©a, t∆∞ v·∫•n   | "G·ª£i √Ω laptop cho sinh vi√™n", "So s√°nh c√°c s·∫£n ph·∫©m" | Vector RAG ‚Üí ChromaDB         |
| **üí¨ HYBRID**         | Chat chung, h·ªèi ƒë√°p          | "Xin ch√†o", "B·∫°n c√≥ th·ªÉ l√†m g√¨?"                     | Direct LLM Chat               |

### 4 Ch·∫ø ƒë·ªô Chat

| Endpoint                       | M·ª•c ƒë√≠ch                  | T√≠nh nƒÉng                                |
| ------------------------------ | ------------------------- | ---------------------------------------- |
| `/api/assistant/chat`          | **RAG-Enhanced Chat**     | Intent Classification + Function Calling |
| `/api/assistant/function-chat` | **Pure Function Calling** | Ch·ªâ d√πng Database Tools                  |
| `/api/assistant/simple-chat`   | **Simple Retrieval**      | T√¨m ki·∫øm c∆° b·∫£n + LLM                    |
| `/api/assistant/original-chat` | **Original Mode**         | Database stats + LLM                     |

## üîß Database Tools Available

H·ªá th·ªëng cung c·∫•p 8 function tools ƒë·ªÉ truy v·∫•n database:

- `findProductById(id)` - T√¨m s·∫£n ph·∫©m theo ID
- `searchProductsByName(name)` - T√¨m s·∫£n ph·∫©m theo t√™n
- `findProductsByPriceRange(min, max)` - T√¨m theo kho·∫£ng gi√°
- `getAllCategories()` - L·∫•y t·∫•t c·∫£ danh m·ª•c
- `findCategoryById(id)` - T√¨m danh m·ª•c theo ID
- `findProductsByCategoryId(id)` - L·∫•y s·∫£n ph·∫©m theo danh m·ª•c
- `countProductsByCategory(name)` - ƒê·∫øm s·∫£n ph·∫©m theo danh m·ª•c
- `getDatabaseStatistics()` - Th·ªëng k√™ t·ªïng quan

## ‚≠ê T√≠nh nƒÉng ch√≠nh

- **ü§ñ Function Calling**: T√≠ch h·ª£p LangChain4j Tools v·ªõi PostgreSQL database
- **üß† Intent Classification**: Ph√¢n lo·∫°i ng·ªØ nghƒ©a v·ªõi confidence scoring
- **üîç Multi-mode Chat**: 4 ch·∫ø ƒë·ªô chat cho c√°c use case kh√°c nhau
- **üìä Smart Database Query**: 8 function tools truy v·∫•n d·ªØ li·ªáu th√¥ng minh
- **üéØ Real-time Processing**: Response nhanh v·ªõi caching mechanism
- **üåê RESTful APIs**: ƒê·∫ßy ƒë·ªß endpoints qu·∫£n l√Ω d·ªØ li·ªáu v√† chat
- **üõ°Ô∏è Error Handling**: Robust error handling v·ªõi fallback mechanisms
- **üìù Rich Responses**: Format k·∫øt qu·∫£ v·ªõi emoji v√† markdown

---

## üíª Tech Stack

<table>
<tr>
<td><strong>üéØ Backend Framework</strong></td>
<td>Spring Boot 3.4.5, Java 17, Maven</td>
</tr>
<tr>
<td><strong>ü§ñ AI/LLM Stack</strong></td>
<td>LangChain4j 1.0.0, Google Gemini (Vertex AI), Function Calling</td>
</tr>
<tr>
<td><strong>üóÑÔ∏è Databases</strong></td>
<td>PostgreSQL (Main DB), ChromaDB (Vector Store), Testcontainers</td>
</tr>
<tr>
<td><strong>üß† ML/Embedding</strong></td>
<td>text-multilingual-embedding-002, Local Embedding (Fallback)</td>
</tr>
<tr>
<td><strong>üîß Tools & Utils</strong></td>
<td>Docker, Lombok, SLF4J Logging</td>
</tr>
<tr>
<td><strong>üåê API & Web</strong></td>
<td>Spring Web, RESTful APIs, CORS Support</td>
</tr>
</table>

---

## Prerequisites

| Tool           | Version | Purpose                                                                                  |
| -------------- | ------- | ---------------------------------------------------------------------------------------- |
| **Java JDK**   | 17+     | [Download](https://www.oracle.com/java/technologies/javase/jdk17-archive-downloads.html) |
| **Maven**      | 3.8+    | [Download](https://maven.apache.org/download.cgi)                                        |
| **Docker**     | Latest  | [Download](https://www.docker.com/products/docker-desktop/)                              |
| **PostgreSQL** | 13+     | [Download](https://www.postgresql.org/download/)                                         |

---

## Configuration

### 1. PostgreSQL Database

C·∫•u h√¨nh trong `src/main/resources/application.properties`:

```properties
# Database Configuration
spring.datasource.url=jdbc:postgresql://localhost:5432/your_database
spring.datasource.username=your_username
spring.datasource.password=your_password
spring.jpa.hibernate.ddl-auto=update

# JPA Settings
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```

### 2. ChromaDB (Vector Database)

ChromaDB ƒë∆∞·ª£c qu·∫£n l√Ω t·ª± ƒë·ªông th√¥ng qua **Testcontainers**. Ch·ªâ c·∫ßn ƒë·∫£m b·∫£o Docker ƒëang ch·∫°y.

### 3. Google Vertex AI Setup

#### üîß **B∆∞·ªõc 1: T·∫°o Google Cloud Project**

```bash
# T·∫°o project m·ªõi
gcloud projects create your-project-id --name="Chatbot Project"

# Set project l√†m default
gcloud config set project your-project-id

# Ki·ªÉm tra project hi·ªán t·∫°i
gcloud config get-value project
```

#### üîß **B∆∞·ªõc 2: Enable Required APIs**

```bash
# Enable Vertex AI API
gcloud services enable aiplatform.googleapis.com

# Enable Compute Engine API (required)
gcloud services enable compute.googleapis.com

# Ki·ªÉm tra APIs ƒë√£ enable
gcloud services list --enabled --filter="aiplatform.googleapis.com OR compute.googleapis.com"
```

#### üîß **B∆∞·ªõc 3: Authentication Setup**

**Option A: Application Default Credentials (Recommended for Development)**

```bash
# Login v·ªõi user account
gcloud auth application-default login

# Verify authentication
gcloud auth application-default print-access-token
```

**Option B: Service Account (Recommended for Production)**

```bash
# T·∫°o service account
gcloud iam service-accounts create chatbot-service-account \
    --description="Service account for chatbot application" \
    --display-name="Chatbot Service Account"

# G√°n quy·ªÅn Vertex AI User
gcloud projects add-iam-policy-binding your-project-id \
    --member="serviceAccount:chatbot-service-account@your-project-id.iam.gserviceaccount.com" \
    --role="roles/aiplatform.user"

# T·∫°o v√† download key file
gcloud iam service-accounts keys create ~/chatbot-service-key.json \
    --iam-account=chatbot-service-account@your-project-id.iam.gserviceaccount.com

# Set environment variable
export GOOGLE_APPLICATION_CREDENTIALS="$HOME/chatbot-service-key.json"
```

#### üîß **B∆∞·ªõc 4: Configure Application**

Th√™m v√†o `application.properties`:

````properties
# Google Cloud Configuration
google.cloud.project-id=your-project-id
google.cloud.location=us-central1

# LangChain4j Vertex AI Configuration
langchain4j.vertex-ai.project-id=${google.cloud.project-id}
langchain4j.vertex-ai.location=${google.cloud.location}
langchain4j.vertex-ai.model-name=gemini-pro

# Embedding Model Configuration
langchain4j.embedding.model=text-multilingual-embedding-002
langchain4j.embedding.dimension=768



#### üìä **Vertex AI Pricing** (Reference)

| Model | Input (per 1K tokens) | Output (per 1K tokens) |
|-------|----------------------|------------------------|
| Gemini Pro | $0.000125 | $0.000375 |
| text-multilingual-embedding-002 | $0.0001 | - |

---

## üöÄ API Endpoints

### 1. ü§ñ Chat Endpoints

#### RAG-Enhanced Chat (Recommended)
```http
POST /api/assistant/chat
Content-Type: application/json

{
    "message": "T√¥i mu·ªën t√¨m laptop Gaming d∆∞·ªõi 25 tri·ªáu"
}
````

**Response:**

```json
{
  "success": true,
  "response": "üéÆ T√¥i t√¨m th·∫•y m·ªôt s·ªë laptop Gaming ph√π h·ª£p...",
  "intent": "DATABASE_QUERY",
  "confidence": 0.89,
  "retrievedContext": "üì¶ S·∫¢N PH·∫®M T√åM ƒê∆Ø·ª¢C...",
  "timestamp": 1703123456789
}
```

#### Pure Function Calling Chat

```http
POST /api/assistant/function-chat
Content-Type: application/json

{
    "message": "S·∫£n ph·∫©m ID 5 gi√° bao nhi√™u?"
}
```

#### Simple Chat

```http
POST /api/assistant/simple-chat
Content-Type: application/json

{
    "message": "C√≥ laptop Dell n√†o kh√¥ng?"
}
```

#### Original Chat (Database Stats)

```http
POST /api/assistant/original-chat
Content-Type: application/json

{
    "message": "Th·ªëng k√™ s·∫£n ph·∫©m"
}
```

### 2. üìä Data Management

#### Get All Products

```http
GET /api/assistant/search/products?keyword=laptop
```

#### Get Product Details

```http
GET /api/assistant/product/123
```

#### Get Statistics

```http
GET /api/assistant/statistics
```

#### Search Categories

```http
GET /api/assistant/search/categories?keyword=ƒëi·ªán%20t·ª≠
```

### 3. üîß System Management

#### Check Vector Store Status

```http
GET /api/assistant/vector-status
```

#### Initialize Vector Store

```http
POST /api/assistant/initialize-vectors
```

### 4. üìù Example Chat Queries

| Lo·∫°i c√¢u h·ªèi            | V√≠ d·ª•                               | Endpoint ƒë∆∞·ª£c khuy·∫øn ngh·ªã      |
| ----------------------- | ----------------------------------- | ------------------------------ |
| **T√¨m s·∫£n ph·∫©m c·ª• th·ªÉ** | "Gi√° iPhone 15 l√† bao nhi√™u?"       | `/api/assistant/function-chat` |
| **Kho·∫£ng gi√°**          | "Laptop t·ª´ 15-25 tri·ªáu"             | `/api/assistant/chat`          |
| **T∆∞ v·∫•n**              | "Laptop n√†o ph√π h·ª£p cho sinh vi√™n?" | `/api/assistant/chat`          |
| **Th·ªëng k√™**            | "C√≥ bao nhi√™u s·∫£n ph·∫©m?"            | `/api/assistant/function-chat` |
| **Chat chung**          | "Xin ch√†o, b·∫°n c√≥ th·ªÉ l√†m g√¨?"      | `/api/assistant/simple-chat`   |

---

## üîß Troubleshooting

### Common Issues

**üî¥ Vertex AI Authentication Error**

```bash
# Re-authenticate
gcloud auth application-default revoke
gcloud auth application-default login
```

**üî¥ Function Calling Not Working**

- ‚úÖ Ki·ªÉm tra DatabaseTools c√≥ ƒë∆∞·ª£c register ƒë√∫ng kh√¥ng
- ‚úÖ Xem logs ƒë·ªÉ debug function execution
- ‚úÖ Test v·ªõi `/api/assistant/function-chat` endpoint

**üî¥ Intent Classification Issues**

```bash
# Check embedding service status
curl GET http://localhost:8080/api/assistant/vector-status
```

**üî¥ Database Connection**

- ‚úÖ Ki·ªÉm tra PostgreSQL ƒëang ch·∫°y: `pg_isready`
- ‚úÖ Verify connection string trong `application.yaml`
- ‚úÖ Test database v·ªõi `/api/assistant/statistics`

**üî¥ ChromaDB Vector Store**

```bash
# Reinitialize vector store
curl -X POST http://localhost:8080/api/assistant/initialize-vectors
```

### üöÄ Quick Start Guide

1. **Clone v√† setup:**

```bash
git clone <repository>
cd Chat_Bot_Lang4J
mvn clean install
```

2. **Start PostgreSQL:**

```bash
# Windows
net start postgresql-x64-13

# macOS/Linux
sudo service postgresql start
```

3. **Initialize sample data:**

```bash
mvn spring-boot:run
curl -X POST http://localhost:8080/api/data/init-sample-data
```

4. **Test chat:**

```bash
curl -X POST http://localhost:8080/api/assistant/function-chat \
  -H "Content-Type: application/json" \
  -d '{"message": "C√≥ bao nhi√™u s·∫£n ph·∫©m?"}'
```

### üìä Health Check

```bash
# System status
curl GET http://localhost:8080/api/assistant/statistics
curl GET http://localhost:8080/api/assistant/vector-status

# Test all chat modes
curl -X POST http://localhost:8080/api/assistant/chat -H "Content-Type: application/json" -d '{"message": "Test"}'
curl -X POST http://localhost:8080/api/assistant/function-chat -H "Content-Type: application/json" -d '{"message": "Test"}'
curl -X POST http://localhost:8080/api/assistant/simple-chat -H "Content-Type: application/json" -d '{"message": "Test"}'
```

---
